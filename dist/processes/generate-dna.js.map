{"version":3,"file":"generate-dna.js","sourceRoot":"","sources":["../../src/processes/generate-dna.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,aAAa,EAAE,MAAM,4BAA4B,CAAC;AAC3D,OAAO,IAAI,EAAE,EAAE,UAAU,EAAE,MAAM,YAAY,CAAC;AAI9C,MAAM,CAAC,KAAK,UAAU,WAAW,CAC/B,OAAe,EACf,kBAAsC,EACtC,eAAuB,EACvB,IAAY,EACZ,UAAe;IAEf,MAAM,IAAI,CAAC,OAAO,CAAC,CAAC;IAEpB,uBAAuB;IACvB,MAAM,WAAW,GAAG,MAAM,kBAAkB,CAAC,cAAc,CAAC,eAAe,CAAC,CAAC;IAE7E,oCAAoC;IACpC,MAAM,QAAQ,GAAG,WAAW,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,EAAC,QAAQ,EAAC,EAAE,CAC1D,SAAS,CAAC,kBAAkB,EAAE,QAAQ,CAAC,aAAa,CAAC,CACtD,CAAC;IACF,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IAE1C,wBAAwB;IACxB,MAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC;QACjC,IAAI,CAAC,OAAO,CAAC,IAAI;QACjB,EAAE,SAAS,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE;KAClD,CAAC,CAAC;IACH,MAAM,aAAa,GAAG,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC;IACjE,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;IAE/C,iBAAiB;IACjB,MAAM,EAAE,gBAAgB,EAAE,QAAQ,EAAE,GAAG,MAAM,UAAU,CACrD,WAAW,CAAC,IAAI,EAChB,IAAI,EACJ,UAAU,EACV,QAAQ,EACR,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,UAAU,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAChE,CAAC;IAEF,MAAM,kBAAkB,CAAC,sBAAsB,CAAC;QAC9C,iBAAiB,EAAE,eAAe;QAClC,qBAAqB,EAAE,aAAa,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,CAAC;QAC9D,UAAU;QACV,IAAI;KACL,CAAC,CAAC;IAEH,sBAAsB;IACtB,OAAO,IAAI,IAAI,CAAC,CAAC,IAAI,UAAU,CAAC,gBAAgB,CAAC,CAAC,MAAM,CAAC,EAAE,kBAAkB,EAAE;QAC7E,IAAI,EAAE,0BAA0B;KACjC,CAAC,CAAC;AACL,CAAC;AAED,KAAK,UAAU,SAAS,CACtB,kBAAsC,EACtC,WAAmB;IAEnB,MAAM,OAAO,GAAG,MAAM,kBAAkB,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;IAEjE,MAAM,IAAI,GAAG,MAAM,kBAAkB,CAAC,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;IACtE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;AAC3B,CAAC","sourcesContent":["import { serializeHash } from '@holochain-open-dev/common';\nimport init, { bundle_dna } from 'bundle_dna';\nimport { CompositoryService } from '../services/compository-service';\nimport { ZomeDef } from '../types/dnas';\n\nexport async function generateDna(\n  wasmUrl: string,\n  compositoryService: CompositoryService,\n  dnaTemplateHash: string,\n  uuid: string,\n  properties: any\n): Promise<File> {\n  await init(wasmUrl);\n\n  // Get the dna template\n  const dnaTemplate = await compositoryService.getDnaTemplate(dnaTemplateHash);\n\n  // Fetch all zomes for that template\n  const promises = dnaTemplate.zome_defs.map(async zome_def =>\n    fetchZome(compositoryService, zome_def.zome_def_hash)\n  );\n  const zomes = await Promise.all(promises);\n\n  // Prepare the arguments\n  const argZomes = zomes.map(zome => [\n    zome.zomeDef.name,\n    { wasm_hash: Array.from(zome.zomeDef.wasm_hash) },\n  ]);\n  const codesPromises = zomes.map(zome => zome.file.arrayBuffer());\n  const codes = await Promise.all(codesPromises);\n\n  // Bundle the dna\n  const { bundled_dna_file, dna_hash } = await bundle_dna(\n    dnaTemplate.name,\n    uuid,\n    properties,\n    argZomes,\n    codes.map(code => ({ code: Array.from(new Uint8Array(code)) }))\n  );\n\n  await compositoryService.publishInstantiatedDna({\n    dna_template_hash: dnaTemplateHash,\n    instantiated_dna_hash: serializeHash(new Uint8Array(dna_hash)),\n    properties,\n    uuid,\n  });\n\n  // Return the contents\n  return new File([new Uint8Array(bundled_dna_file).buffer], 'generated.dna.gz', {\n    type: 'application/octet-stream',\n  });\n}\n\nasync function fetchZome(\n  compositoryService: CompositoryService,\n  zomeDefHash: string\n): Promise<{ zomeDef: ZomeDef; file: File }> {\n  const zomeDef = await compositoryService.getZomeDef(zomeDefHash);\n\n  const file = await compositoryService.downloadFile(zomeDef.wasm_file);\n  return { zomeDef, file };\n}\n"]}